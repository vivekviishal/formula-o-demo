const variableSuggestions = [
    {
        id: "ravi-demo_cif_20220331005054981-c050c530e41b391",
        label: "Player Spend",
        key: "player_spend",
        type: "number",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220331005056104-0c9d6a607d9951a",
        label: "Banned",
        key: "banned",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220331005056105-cbd868d9322aa53",
        label: "Player ID",
        key: "player_id",
        type: "number",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220331005056140-be4b80dcb91758f",
        label: "Game Name",
        key: "game_name",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220331005056142-6bec5c2b0262681",
        label: "Issue Category",
        key: "issue_category",
        type: "dropdown",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220331005056144-82f8d3d20618d3a",
        label: "rpg",
        key: "rpg",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220505181059394-3cb2ec52a75ba15",
        label: "Language",
        key: "language",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220513021844925-b8d5c04aedd12ec",
        label: "Domain",
        key: "domain",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20220628165021647-ebc9539294ad4d0",
        label: "score",
        key: "score",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220628210740746-1c487f5fbdf6b0a",
        label: "Email",
        key: "email",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220628212222713-ca35876ff35815b",
        label: "Message",
        key: "message",
        type: "multiline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220628215250304-dc29997b0fb16b7",
        label: "OTP",
        key: "otp",
        type: "number",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220713212718260-832052216f79a07",
        label: "testwebform",
        key: "testwebform",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220725173123952-88b4dd6d2c253ef",
        label: "spend",
        key: "spend",
        type: "number",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220803064825985-6bd67ae281ce743",
        label: "vip",
        key: "vip",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20220908190227634-ead7ab32d3d3236",
        label: "user_rating",
        key: "user_rating",
        type: "number",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20220926173519610-c0b7dc1979724cf",
        label: "is_issue_type_fb",
        key: "is_issue_type_fb",
        type: "checkbox",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221004170658024-72a6b00edba4cb2",
        label: "stockLevel",
        key: "stock_level",
        type: "number",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221004170719629-2d08a0dba088885",
        label: "employeeName",
        key: "employee_name",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221004170743377-cf365402cfaf2ba",
        label: "isPro",
        key: "is_pro",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221018162232151-62490e2994e389a",
        label: "country code",
        key: "country_code",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221031193757355-158fca39ca9aba3",
        label: "joiningDate",
        key: "joiningdate",
        type: "date",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20221205143156787-a8817ec105b4c9c",
        label: "Level",
        key: "level",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20230405201310924-65194db47d483d1",
        label: "Queue Id",
        key: "queue_id",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20230512181738643-0ebeac8395860b3",
        label: "Order Id",
        key: "order_id",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240117105502097-ef49c5e83cb22a5",
        label: "Issue Id",
        key: "issue_id",
        type: "number",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240411062944330-821fb0a3760acb5",
        label: "User-Name",
        key: "user_name",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240411092251492-fc6096820e10ab8",
        label: "nick-name",
        key: "nick_name",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240419064338480-2aae9ddc4109bc1",
        label: "platform",
        key: "platform",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240419065157940-165813c40d36adc",
        label: "websiteUrl",
        key: "website",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240419071606990-4dc52277b3f1c78",
        label: "pageURL",
        key: "pageurl",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240419071706451-457524bd992b7a2",
        label: "Page-site",
        key: "page_site",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240419071713450-f7d963f9dfd3a5c",
        label: "url",
        key: "url",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240419071941937-429e67f9b2be001",
        label: "API",
        key: "api",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240419072025515-04946646f4d05ee",
        label: "task",
        key: "task",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240422072025096-605e4a9de860fa1",
        label: "isAssigned",
        key: "isassigned",
        type: "dropdown",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240429060910190-6471c9af7ef01a2",
        label: "Name",
        key: "name",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240429114222058-7027d5bd3d95d26",
        label: "ishita_cif_",
        key: "ishita_cif_",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240430043530527-c65040654ed92af",
        label: "shreya_cif",
        key: "shreya_cif",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240508181615594-982cacbc22b5db1",
        label: "awaiting agent replied",
        key: "awaiting_agent_replied",
        type: "checkbox",
        is_used_in_chatbots: true,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240509055831293-02b81279429c809",
        label: "awaiting_agent_response",
        key: "awaiting_agent_response",
        type: "checkbox",
        is_used_in_chatbots: true,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240509085502522-c5487cf85629324",
        label: "selectP",
        key: "selectp",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240523093459922-af0ee56dc485dfa",
        label: "delay-complete",
        key: "delay_complete",
        type: "checkbox",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240529052454895-f3bac13b0678c55",
        label: "delay-setting",
        key: "delay_setting",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240529052512796-ab28e147bff5458",
        label: "delay-queued",
        key: "delay_queued",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240619075112220-722233cea30861a",
        label: "Create PDSR Jira",
        key: "create_pdsr_jira",
        type: "checkbox",
        is_used_in_chatbots: false,
        is_editable: true,
    },
    {
        id: "ravi-demo_cif_20240619085444680-665c5824f8ff0b5",
        label: "PDSR jira link",
        key: "pdsr_jira_link",
        type: "singleline",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240626063827578-dc27ac5ad80cd6d",
        label: "scopely_spend_bucket",
        key: "customfield_33000",
        type: "dropdown",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240626064003258-5d212bdafceccf2",
        label: "country",
        key: "customfield_33001",
        type: "singleline",
        is_used_in_chatbots: true,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240626064225335-791b399800e6c52",
        label: "issue_categorization",
        key: "customfield_26019",
        type: "dropdown",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240626064351608-c51c5aface7d333",
        label: "user_id",
        key: "customfield_19528",
        type: "number",
        is_used_in_chatbots: false,
        is_editable: false,
    },
    {
        id: "ravi-demo_cif_20240704070127818-f7ecf1503a27f92",
        label: "Date of Confirmation",
        key: "customfield_27923",
        type: "date",
        is_used_in_chatbots: false,
        is_editable: true,
    },
];

function detectCurlyBraces(event) {
    if (event.keyCode === 219) {
        event.preventDefault();
        const inputValue = event.target;
        const formula = inputValue.value;
        const cursorPosition = inputValue.selectionStart;
        const updatedFormula =
            formula.slice(0, cursorPosition) +
            "}" +
            formula.slice(cursorPosition);
        inputValue.value = updatedFormula;
        inputValue.setSelectionRange(cursorPosition, cursorPosition);
    }
}

const fuseOptions = {
    shouldSort: true,
    threshold: 0.3,
    keys: ["key"],
};
const fuse = new Fuse(variableSuggestions, fuseOptions);

function showAutocomplete(event) {
    const input = event.target;
    const value = input.value;
    const cursorPosition = input.selectionStart;
    const inputValue = value.slice(0, cursorPosition);
    console.log("Input value:" + inputValue);
    const match = inputValue.match(/{([^}]+)$/);
    console.log(`Match: ${match}`);
    closeAutocompleteList();

    if (!match || !match[1]) {
        return;
    }

    const currentVariable = match[1].toLowerCase();
    const list = document.createElement("div");
    list.setAttribute("id", input.id + "autocomplete-list");
    list.setAttribute("class", "autocomplete-items");

    const inputRect = input.getBoundingClientRect();
    list.style.position = "absolute";
    list.style.top = `${inputRect.bottom}px`; // Adjust top position as needed
    list.style.left = `${inputRect.left}px`;
    list.style.width = `${input.offsetWidth}px`; // Match width of input
    list.style.boxSizing = "border-box";
    input.parentNode.appendChild(list);

    const results = fuse.search(currentVariable);
    console.log(`Results: ${results}`);

    if (!results || results.length === 0) {
        return;
    }

    results.forEach((result) => {
        const variable = result.item.key;
        console.log(`Variable: ${variable}`);
        const item = document.createElement("div");
        item.innerHTML =
            "<strong>" +
            variable.substr(0, currentVariable.length) +
            "</strong>";
        item.innerHTML += variable.substr(currentVariable.length);
        item.innerHTML += '<input type="hidden" value="' + variable + '">';
        item.addEventListener("click", () => {
            input.value =
                value.slice(0, cursorPosition - currentVariable.length) +
                variable +
                input.value.slice(cursorPosition);
            closeAutocompleteList();
            input.focus();
            input.setSelectionRange(
                cursorPosition + variable.length - currentVariable.length,
                cursorPosition + variable.length - currentVariable.length
            );
        });
        item.style.cursor = "pointer";
        // item.style.borderBottom = "1px solid black";
        list.appendChild(item);
    });
}

function closeAutocompleteList() {
    const items = document.getElementsByClassName("autocomplete-items");
    for (let i = 0; i < items.length; i++) {
        items[i].parentNode.removeChild(items[i]);
    }
}

document.addEventListener("click", (e) => {
    closeAutocompleteList();
});

function validateFormula() {
    const formula = document.getElementById("formula").value;
    if (formula === "") {
        alert("Formula cannot be empty");
        return;
    }

    const dynamicInputValuesDiv = document.getElementById(
        "dynamic-input-values"
    );
    dynamicInputValuesDiv.innerHTML = "";
    const parsedFormula = formula.replace(/{([^}]+)}/g, "$1");
    if (parsedFormula.includes("=")) {
        alert("formula cannot contain equal(=) sign");
        return;
    }

    try {
        const parsed = math.parse(parsedFormula);
        const variables = [];
        parsed.traverse(function (node, path, parent) {
            if (node.type === "SymbolNode") {
                variables.push(node.name);
            }
        });

        const uniqueVariables = [...new Set(variables)];
        uniqueVariables.forEach((variable) => {
            const inputDiv = document.createElement("div");
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = variable;
            input.id = variable;
            inputDiv.appendChild(input);
            dynamicInputValuesDiv.appendChild(inputDiv);
        });

        const submitButton = document.createElement("button");
        submitButton.textContent = "Submit";
        submitButton.onclick = submitFormula;
        dynamicInputValuesDiv.appendChild(submitButton);
    } catch (error) {
        alert("Invalid formula");
    }
}

function submitFormula() {
    const formula = document.getElementById("formula").value;
    const parsedFormula = formula.replace(/{([^}]+)}/g, "$1");
    const variables = document.querySelectorAll("#dynamic-input-values input");
    const values = {};
    variables.forEach((input) => {
        values[input.id] = parseFloat(input.value);
    });

    const dynamicResultDiv = document.getElementById("dynamic-result");
    dynamicResultDiv.innerHTML = ""; // Clear previous results

    try {
        const result = math.evaluate(parsedFormula, values);
        if (!result) {
            alert("Evaluation failed, Please check your input values");
            return;
        }
        const resultDiv = document.createElement("div");
        resultDiv.classList.add("result");
        dynamicResultDiv.appendChild(resultDiv);

        const resultCIF = document.createElement("input");
        resultCIF.addEventListener("keyup", (event) => {
            detectCurlyBraces(event);
            showAutocomplete(event);
        });
        resultCIF.type = "text";
        resultCIF.placeholder = `{Result_CIF}`;
        resultCIF.id = "resultCIF";
        resultDiv.appendChild(resultCIF);

        const resultOutput = document.createElement("p");
        resultOutput.textContent = ` = ${result}`;
        resultDiv.appendChild(resultOutput);

        const saveButton = document.createElement("button");
        saveButton.textContent = "Save";
        dynamicResultDiv.appendChild(saveButton);
        saveButton.addEventListener("click", () => {
            if (!resultCIF.value) {
                alert("Result CIF cannot be empty");
                return;
            } else {
                saveFormula();
            }
        });
    } catch (error) {
        alert("Evaluation failed");
    }
}

async function saveFormula() {
    let formula = document.getElementById("formula").value;
    let resultCIF = document.getElementById("resultCIF").value;
    let data = { formula: `${resultCIF}=${formula}` };

    const url = "http://localhost:7071/api/saveFormula";

    try {
        const response = await fetch(url, {
            method: "POST",
            mode: "no-cors",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        });
        console.log(response);
        if (response.msg === "failed") {
            alert("Failed to save formula");
        }
    } catch (error) {
        console.error("Error:", error);
    }
    location.reload();
}

async function displayFormulaInTable() {
    const table = document
        .getElementById("formulas-table")
        .getElementsByTagName("tbody")[0];
    const url = "http://localhost:7071/api/readFormula";

    try {
        const response = await fetch(url, {
            method: "GET",
            mode: "no-cors",
        });
        console.log(response);
    } catch (error) {
        console.error("Error:", error);
    }
    const newRow = table.insertRow();

    const idCell = newRow.insertCell(0);
    const formulaCell = newRow.insertCell(1);
    const actionsCell = newRow.insertCell(2);

    idCell.textContent = "1";
    formulaCell.textContent = "{CIF_1} + {CIF_2}";
    actionsCell.innerHTML =
        '<button onclick="deleteFormula(this)">Delete</button>';
}
displayFormulaInTable();

function deleteFormula(button) {
    const row = button.parentNode.parentNode;
    row.parentNode.removeChild(row);
}
